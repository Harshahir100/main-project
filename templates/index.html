<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Python Instructor</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      height: 100vh;
      margin: 0;
      display: flex;
    }
    /* Sidebar */
    .sidebar { width: 280px; background: rgba(20, 20, 20, 0.95); display: flex; flex-direction: column; justify-content: space-between; border-right: 1px solid #333; padding: 15px; }
    .sidebar-top, .sidebar-bottom { display: flex; flex-direction: column; gap: 10px; }
    .sidebar button { padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #fff; transition: all 0.3s ease; }
    .new-chat-btn { background: linear-gradient(135deg, #2196F3, #0D47A1); }
    .new-chat-btn:hover { background: linear-gradient(135deg, #1E88E5, #1565C0); }
    .delete-history-btn { background: linear-gradient(135deg, #f44336, #b71c1c); }
    .delete-history-btn:hover { background: linear-gradient(135deg, #e53935, #c62828); }
    .view-history-btn { background: linear-gradient(135deg, #4caf50, #2e7d32); }
    .view-history-btn:hover { background: linear-gradient(135deg, #43a047, #1b5e20); }
    .history-list { flex: 1; margin: 15px 0; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #4caf50 transparent; }
    .history-item { background: #2c2c2c; border-radius: 8px; padding: 10px; margin-bottom: 8px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s; }
    .history-item:hover { background: #3c3c3c; }
    /* Chat area */
    .chat-container { flex: 1; display: flex; flex-direction: column; }
    .chat-header { background: #1f1f1f; padding: 15px; text-align: center; font-size: 1.3rem; font-weight: bold; border-bottom: 1px solid #333; }
    .chat-box { flex: 1; padding: 20px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #4caf50 transparent; }
    .message { margin-bottom: 15px; padding: 12px 15px; border-radius: 14px; max-width: 75%; white-space: pre-wrap; word-wrap: break-word; }
    .user-msg { background: linear-gradient(135deg, #4caf50, #2e7d32); align-self: flex-end; margin-left: auto; }
    .bot-msg { background: #2c2c2c; border: 1px solid #444; align-self: flex-start; margin-right: auto; }
    .chat-input { display: flex; border-top: 1px solid #333; background: #1f1f1f; padding: 12px; }
    .chat-input input { flex: 1; padding: 12px; border: none; border-radius: 8px; background: #2c2c2c; color: #fff; font-size: 14px; }
    .chat-input button { margin-left: 10px; padding: 12px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #4caf50, #2e7d32); color: #fff; font-weight: bold; cursor: pointer; }
    .chat-input button:hover { background: linear-gradient(135deg, #43a047, #1b5e20); }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-top">
      <button class="new-chat-btn" id="newChatBtn">+ New Chat</button>
    </div>
    <div class="history-list" id="historyList"></div>
    <div class="sidebar-bottom">
<button class="view-history-btn" onclick="window.location.href='/history'">
  View All History
</button>
      <button class="delete-history-btn" id="deleteHistoryBtn">Delete History</button>
    </div>
  </div>

  <!-- Chat Area -->
  <div class="chat-container">
    <div class="chat-header">ðŸ’» Python Instructor</div>
    <div class="chat-box" id="chatBox"></div>
    <form class="chat-input" id="chatForm">
      <input type="text" id="query" placeholder="Ask your Python question..." required>
      <button type="submit">Send</button>
    </form>
  </div>

  <script>
    const chatBox = document.getElementById("chatBox");
    const queryInput = document.getElementById("query");
    const chatForm = document.getElementById("chatForm");
    const historyList = document.getElementById("historyList");

    async function loadHistory() {
      let res = await fetch("/history/json"); // âœ… fixed
      let data = await res.json();
      historyList.innerHTML = "";

      if (Object.keys(data).length === 0) {
        historyList.innerHTML = "<p style='color:#aaa; text-align:center;'>No history</p>";
        return;
      }

      for (const [month, conversations] of Object.entries(data)) {
        conversations.forEach((conv) => {
          const div = document.createElement("div");
          div.classList.add("history-item");
          div.textContent = conv.query.substring(0, 40) + (conv.query.length > 40 ? "..." : "");
          div.addEventListener("click", () => {
            chatBox.innerHTML = "";
            addMessage("Q: " + conv.query, "user");
            addMessage(conv.response, "bot");
          });
          historyList.appendChild(div);
        });
      }
    }

    function addMessage(text, sender) {
      const msg = document.createElement("div");
      msg.classList.add("message", sender === "user" ? "user-msg" : "bot-msg");
      msg.textContent = text;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const query = queryInput.value.trim();
      if (!query) return;
      addMessage(query, "user");
      queryInput.value = "";

      try {
        let response = await fetch("/ask", {
          method: "POST",
          body: new URLSearchParams({ query }),
          headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });
        let data = await response.json();
        addMessage(data.answer, "bot");
        loadHistory();
      } catch (err) {
        addMessage("Error: Cannot connect to server.", "bot");
      }
    });

    document.getElementById("newChatBtn").addEventListener("click", () => {
      chatBox.innerHTML = "";
      addMessage("Started a new chat. How can I help you with Python today?", "bot");
    });

    document.getElementById("deleteHistoryBtn").addEventListener("click", async () => {
      await fetch("/delete-history", { method: "POST" });
      loadHistory();
    });

    loadHistory();
  </script>
</body>
</html>
